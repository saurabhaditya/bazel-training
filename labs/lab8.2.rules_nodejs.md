# Lab 8.2 - rules_nodejs

## Installation

First we create a new workspace, which will be in a new directory.
We can use the `@bazel/create` npm package to do this in one command.

This is the fastest way to get started for most use cases.
```bash
$ npm init @bazel my_workspace
$ cd my_workspace
```
You could do the same thing with yarn:
```bash
$ yarn create @bazel my_workspace
$ cd my_workspace
```

Both of these commands are equivalent to `npx @bazel/create` which downloads
the latest version of the `@bazel/create` package from npm and runs the program
it contains. Run the tool with no arguments for command-line options and next
steps.

If you don’t have npm or yarn, no worries, we did the first steps for you
already, so you can just copy `src/js/my_workspace_files` into `src/js/my_workspace`.

Next we install some development tools. For this example, we’ll use Babel
to transpile our JavaScript, Mocha for running tests, and http-server to
serve our app. These are arbitrary choices, you may use whatever are your
favorites.
```bash
$ npm install @babel/core @babel/cli @babel/preset-env http-server mocha source-map
```

If you created workspace using the steps above, then also please copy next files
from `src/js/my_workspace_files`: `app.js`, `app.spec.js`, `es5.babelrc`, `index.html`.


## Using Babel

Next we want to teach Bazel how to transform our JavaScript inputs into transpiled
outputs since some old browsers do not support es6 (for example IE11), and
we want to transpile it into es5.

Create target that uses babel rule from `load("@npm//@babel/cli:index.bzl", "babel")`
and triggers Babel to produce `app.es5.js`.

Without bazel it would be next command:
```bash
npx babel app.js --config-file es5.babelrc --out-file app.es5.js
```

After it's done, you should be able to build the application:
`npm run build` or `bazel build //...` (they do the same).
And we see the `app.es5.js` output from babel appear in the
`src/js/my_workspace/dist/bin` folder.

<details>
  <summary>Hint</summary> Add next content to <code>src/js/my_workspace/BUILD.bazel</code>:

```bazel
load("@npm//@babel/cli:index.bzl", "babel")

babel(
    name = "compile",
    data = [
        "app.js",
        "es5.babelrc",
        "@npm//@babel/preset-env",
    ],
    outs = ["app.es5.js"],
    args = [
        "app.js",
        "--config-file",
        "./$(execpath es5.babelrc)",
        "--out-file",
        "$(execpath app.es5.js)",
    ],
)
```
</details>


## Serving the app

Let’s serve the app to see how it looks, by adding `http_server` target to BUILD.bazel.
It should reproduce step `npx http_server .`, gets `index.html` and `app.es5.js` as data.

If you use npm, make sure you have a serve entry to the scripts in `package.json`:
```json
{
  "scripts": {
    "serve": "ibazel run :server"
  }
}
```

After it's done, you should be able to serve the app:
`npm run serve` or `ibazel run //:server`.

Check that if you open `http://localhost:8080` in the browser,
it shows `Hello, JavaScript` message.

<details>
  <summary>Hint</summary> Add next content to <code>src/js/my_workspace/BUILD.bazel</code>:

```bazel
load("@npm//http-server:index.bzl", "http_server")

http_server(
    name = "server",
    data = [
        "index.html",
        "app.es5.js",
    ],
    args = ["."],
)
```
</details>


## Testing the app

Finally, let's run a test using Mocha test framework and the `source-map` package,
so we can check sourcemaps generated by babel.

It should be imported from
```bazel
load("@npm//mocha:index.bzl", "mocha_test")
```
and test all spec files in the folder, so without bazel command would look like
`npx mocha "*.spec.js"`

After it's done, you should be able to run the tests: `npm test` or `bazel test //...`.

<details>
  <summary>Hint</summary> Add next content to <code>src/js/my_workspace/BUILD.bazel</code>:

```bazel
load("@npm//mocha:index.bzl", "mocha_test")

mocha_test(
    name = "unit_tests",
    args = ["*.spec.js"],
    data = glob(["*.spec.js"]) + [
        "@npm//source-map",
        "app.es5.js",
    ],
)
```
</details>

